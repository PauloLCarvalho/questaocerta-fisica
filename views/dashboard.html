<?php
require_once __DIR__ . '/../includes/auth.php';
qc_require_login();

// Debug: log current session state to help diagnose session issues
@file_put_contents(__DIR__ . '/../logs/auth.log', sprintf("%s DASHBOARD LOAD: session_email=%s session_nivel=%s ip=%s\n", date('c'), $_SESSION['email'] ?? '-', $_SESSION['nivel'] ?? '-', $_SERVER['REMOTE_ADDR'] ?? '-'), FILE_APPEND | LOCK_EX);
// prepare display email with a fallback so the UI always shows something for testing
$__qc_email_raw = qc_user_email();
$__qc_display_email = $__qc_email_raw ? $__qc_email_raw : 'teste@exemplo.com';

// Debug: adiciona informação da sessão atual
$__debug_info = sprintf(
    "Email: %s, Nível: %s, Nome: %s",
    $_SESSION['email'] ?? 'não definido',
    $_SESSION['nivel'] ?? 'não definido',
    $_SESSION['nome'] ?? 'não definido'
);
@file_put_contents(__DIR__ . '/../logs/debug.log', date('Y-m-d H:i:s') . " - " . $__debug_info . "\n", FILE_APPEND | LOCK_EX);
?>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Questão Certa</title>
  <link rel="stylesheet" href="../assets/style.css">
  <style>
    /* small layout for header user email near logout button */
    .nav-links .user-email {
      font-size: 0.95rem;
      color: #333;
      background: #eef2ff;
      padding: 6px 10px;
      border-radius: 8px;
      display: inline-block;
      white-space: nowrap;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 8px;
    }
    .nav-links {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    /* back-to-top button */
    .back-to-top {
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--azul-escuro);
      color: #fff;
      border: none;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
    }

    /* settings drawer styles for dashboard */
    .btn-settings { background: transparent; border: none; font-size: 1.1rem; cursor: pointer; padding: 6px 10px; color: var(--azul-escuro); }
    .settings-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; z-index: 1200; }
    .settings-drawer { position: fixed; left: -320px; top: 0; height: 100vh; width: 320px; background: #fff; box-shadow: 2px 0 20px rgba(0,0,0,0.2); z-index: 1300; padding: 18px; transition: left 0.32s ease; overflow: auto; }
    .settings-drawer.open { left: 0; }
    .settings-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .settings-item { margin:12px 0; }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html" class="logo">Questão Certa</a>
      <div class="nav-links">
        <span class="user-email" id="user-email" data-email="<?= htmlspecialchars($__qc_display_email, ENT_QUOTES, 'UTF-8') ?>" title="<?= htmlspecialchars($__qc_display_email, ENT_QUOTES, 'UTF-8') ?>"><?= htmlspecialchars($__qc_display_email) ?></span>
        <a href="../api/auth.php?action=logout" class="btn btn-azul">Sair</a>
      </div>
    </nav>
  </header>

  <section class="dashboard">
    <div class="wrapper">
      
      <div class="welcome">
        <h2>Bem-vindo, <strong><?= htmlspecialchars(qc_user_name()) ?></strong>!</h2>
        <p>Escolha uma disciplina.</p>
      </div>

      <!-- Debug info removed, banner removed -->

      <h2 style="text-align:center; color:var(--azul); margin:2rem 0 1.5rem;">Disciplinas</h2>
      <div class="materias">
        <div class="card" onclick="location.href='questoes.html?materia=fisica'">
          <h3>Física</h3>
          <p>Mecânica, energia, eletricidade</p>
        </div>
        <div class="card" onclick="location.href='questoes.html?materia=matematica'">
          <h3>Matemática</h3>
          <p>Questões de matemática</p>
        </div>
        <div class="card" onclick="location.href='questoes.html?materia=natureza'">
          <h3>Ciências da Natureza</h3>
          <p>Biologia, Química</p>
        </div>
        <div class="card" onclick="location.href='revisao.html'">
          <h3>Revisão</h3>
          <p>Questões erradas</p>
        </div>
      </div>
    </div>
  </section>

  <!-- settings drawer and toggle (dashboard only) -->
  <button id="settings-toggle" class="btn-settings" title="Configurações" aria-label="Abrir configurações" style="position:fixed; left:14px; bottom:18px; z-index:2001;">⚙️</button>
  <div id="settings-overlay" class="settings-overlay" onclick="closeSettings()"></div>
  <aside id="settings-drawer" class="settings-drawer" aria-hidden="true" role="dialog">
    <div class="settings-header">
      <strong>Configurações</strong>
      <button onclick="closeSettings()" class="btn-settings" aria-label="Fechar configurações">✖</button>
    </div>
    <div class="settings-item">
      <label><input type="checkbox" id="dark-mode-toggle" aria-label="Ativar modo escuro" /> Modo escuro</label>
    </div>
    <div class="settings-item">
      <button id="limpar-revisao" class="btn-voltar" style="background:#c62828;">Limpar revisão</button>
      <p style="font-size:0.82rem; color:#666; margin-top:8px;">Remove todas as questões da sua lista de revisão.</p>
    </div>
  </aside>

  <!-- back to top -->
  <button id="back-to-top" class="back-to-top" title="Voltar ao topo" aria-label="Voltar ao topo">↑</button>

  <footer>
    <p>&copy; <?= date('Y') ?> Questão Certa.</p>
  </footer>

  <script>
    // Debug: mostrar email no console (comente em produção)
    // console.log('Email do usuário:', <?= json_encode($__qc_display_email) ?>);
  </script>

  <script>
    // Esperar o DOM carregar antes de executar qualquer código
    document.addEventListener('DOMContentLoaded', () => {
      // Debug: mostrar email do elemento no console (comente em produção)
      // const emailElement = document.getElementById('user-email');
      // if (emailElement) {
      //   console.log('Email do usuário:', emailElement.dataset.email);
      // }

      // back to top behavior
      const btt = document.getElementById('back-to-top');
      if (btt) {
        window.addEventListener('scroll', () => {
          btt.style.display = window.scrollY > 200 ? 'flex' : 'none';
        });
        btt.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
      }

      // settings drawer behavior (dashboard)
      const settingsToggle = document.getElementById('settings-toggle');
      const settingsDrawer = document.getElementById('settings-drawer');
      const settingsOverlay = document.getElementById('settings-overlay');
      const darkModeToggle = document.getElementById('dark-mode-toggle');

      function openSettings() { 
        settingsDrawer.classList.add('open'); 
        settingsOverlay.style.display = 'block'; 
        settingsDrawer.setAttribute('aria-hidden', 'false'); 
      }
      function closeSettings() { 
        settingsDrawer.classList.remove('open'); 
        settingsOverlay.style.display = 'none'; 
        settingsDrawer.setAttribute('aria-hidden', 'true'); 
      }
      if (settingsToggle) settingsToggle.addEventListener('click', openSettings);

      // Dark mode
      function applyDarkMode(enabled) { 
        if (enabled) document.body.classList.add('dark-mode'); 
        else document.body.classList.remove('dark-mode'); 
        localStorage.setItem('darkMode', enabled ? '1' : '0'); 
      }
      const dm = localStorage.getItem('darkMode'); 
      if (dm === '1') { 
        if (darkModeToggle) darkModeToggle.checked = true; 
        applyDarkMode(true); 
      }
      if (darkModeToggle) darkModeToggle.addEventListener('change', e => applyDarkMode(e.target.checked));

      // limpar revisão from dashboard
      const limparBtn = document.getElementById('limpar-revisao');
      if (limparBtn) limparBtn.addEventListener('click', () => {
        if (!confirm('Deseja remover todas as questões da lista de revisão? Esta ação não pode ser desfeita.')) return;
        localStorage.removeItem('erros');
        // close and notify
        alert('Lista de revisão limpa.');
        closeSettings();
      });
    });
  </script>
</body>
</html>